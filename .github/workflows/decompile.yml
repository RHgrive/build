name: Decompile dylib

on:
  workflow_dispatch:
    inputs:
      filename:
        description: 'dylib filename'
        required: true

jobs:
  decompile:
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v3

      - name: 必要なツールをインストール
        run: |
          sudo apt update
          sudo apt install -y binutils clang llvm

      - name: GitHub API からファイルを取得
        run: |
          curl -H "Authorization: token ${{ secrets.GH_TOKEN }}" -O https://github.com/rhgrive/build/releases/download/latest/${{ github.event.inputs.filename }}

      - name: 逆アセンブル
        run: |
          otool -tv ${{ github.event.inputs.filename }} > decompiled.txt
          strings ${{ github.event.inputs.filename }} > strings.txt
          nm -g ${{ github.event.inputs.filename }} > symbols.txt

      - name: 結果をアップロード
        uses: actions/upload-artifact@v4
        with:
          name: decompiled-files
          path: |
            decompiled.txt
            strings.txt
            symbols.txt
